<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
      />

  <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"></script>

  <title>garden 첫페이지</title>
  <link rel="stylesheet" href="../static/css/garden.css" />
</head>

<body>

  <!-- 마이페이지 이동 버튼 -->
  <button type="button" class="my-page-btn" onclick="profile()">마이페이지</button>


  <!-- 롤링페이퍼 작성하기 버튼 -->
  <form name="newMsg">
    <!-- <div class="write-container">
      <div> -->
        제목<input type="text" name="title">
      </div>
      <div>
        메시지 내용<input type="text" name="content">
      </div>
      <div>
        <input type="radio" name="isPublic" value="true" id="public">
        <label for="public">메시지 공개 </label>
        //
        <input type="radio" name="isPublic" value="false" id="private">
        <label for="private">메시지 비공개 </label>
      </div>
      <div>
        컬러<input type="color" name="flowerColor">
      </div>
      <br />
      <!-- <button type="button" class="write-btn" onclick="writeMsg()">작성하기</button>
    </div> -->
  </form>

  <div>
    <ul id="mess">
      <%if(msg) {%>
        <%let result=true%>
          <% for (let i=0; i < msg.length; i++) { %>
            <% if(result) { %>
              <form name="mesId">
                <div>
                  <h3>여기는 왼쪽</h3>
                  <input type="hidden" name="mesId" value="<%=msg[i].message_id%>">
                  제목: <%=msg[i].title%> <br />
                    내용: <%=msg[i].content%> <br />
                      공개여부: <%=msg[i].is_public%> <br />
                        <button type="button" onclick="deleteMsg(this)">삭제하기</button>
                </div>
              </form>
              <%result=false%>
                <% } else {%>
                  <form name="mesId">
                    <div style="text-align: right;">
                      <h3>여기는 오른쪽</h3>
                      <input type="hidden" name="mesId" value="<%=msg[i].message_id%>">
                      제목: <%=msg[i].title%> <br />
                        내용: <%=msg[i].content%> <br />
                          공개여부: <%=msg[i].is_public%> <br />
                            <button type="button" onclick="deleteMsg(this)">삭제하기</button>
                  </form>
  </div>
  <%result=true%>
    <%}%>
      <%}%>
        <%} else {%>
          <div>
            <h3>메시지가 없습니다 ㅜㅜ</h3>
          </div>
          <%}%>
            </ul>
            </div>


  <!-- 텃밭, 새싹 부분 -->
  <!-- sprout-btn은 사용자가 롤링페이퍼 게시하면 하나씩 추가되는 걸로 짜야댐-->
  <!-- <div class="garden"></div>
  <div class="sprout-container">
    <button class="sprout-btn">
      <img src="../static/img/sesac.png" alt="Sprout 1" />
    </button>
    <button class="sprout-btn">
      <img src="../static/img/sesac.png" alt="Sprout 2" />
    </button>
    <button class="sprout-btn">
      <img src="../static/img/sesac.png" alt="Sprout 3" />
    </button>
    <button class="sprout-btn">
      <img src="../static/img/sesac.png" alt="Sprout 4" />
    </button>
    <button class="sprout-btn">
      <img src="../static/img/sesac.png" alt="Sprout 5" />
    </button>
  </div> -->

  <nav class="navbar bg-body-tertiary fixed-top">
    <div class="container-fluid">
      <!-- 공유하기 버튼 이미지 만들어서 수정 -->
      <a class="navbar-brand" href="#">공유하기</a>
      <div class="navbar-brand">'s 정원</div>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasNavbar"
        aria-controls="offcanvasNavbar"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div
        class="offcanvas offcanvas-end"
        tabindex="-1"
        id="offcanvasNavbar"
        aria-labelledby="offcanvasNavbarLabel"
      >
        <div class="offcanvas-header">

          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <div class="offcanvas-body">
          <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="/home"
                >홈으로 가기</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/home/signin">로그인</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">산책하기</a>
            </li>
    </div>
  </nav>
  <div class="sky"></div>
  <div class="green"></div>
  <div class="sesac-container">
    <div class="sesac"><img src="../static/img/sesac.png" alt="새싹" /></div>
    <div class="sesac"><img src="../static/img/sesac.png" alt="새싹" /></div>
    <div class="sesac"><img src="../static/img/sesac.png" alt="새싹" /></div>
    <div class="sesac"><img src="../static/img/sesac.png" alt="새싹" /></div>
    <div class="sesac"><img src="../static/img/sesac.png" alt="새싹" /></div>
  </div>



            <script>
              // 회원과 비회원을 구분하는 애니메이션 필요
              function writeMsg() {
                const form = document.forms["newMsg"]

                const msg = {
                  title: form.elements.title.value,
                  content: form.elements.content.value,
                  is_public: form.elements.isPublic.value,
                  flower_color: form.elements.flowerColor.value
                }

                if ("<%=userName%>") { // 세션에 아이디가 있을 때(로그인 O)
                  axios({
                    method: "POST",
                    url: "/home/garden",
                    data: msg
                  }).then((res) => {
                    if (res.data.result) {
                      alert("메시지 작성 완료")
                      location.reload()
                    } else {
                      alert("메시지 작성 실패 ㅜㅜ")
                    }
                  })
                }
                else { // 세션에 아이디가 없을 때(로그인 X)
                  axios({
                    method: "POST",
                    url: "/home/garden",
                    data: msg
                  }).then((res) => {
                    if (res.data.result) {
                      alert("메시지 작성 완료")
                      location.reload()
                    } else {
                      alert("메시지 작성 실패 ㅜㅜ")
                    }
                  })
                }

              }


              // 메시지 삭제
              function deleteMsg(button) {
                const form = button.closest("form")
                let delMess = {
                  mesId: form.querySelector('[name="mesId"]').value,
                  gdName: "<%=userName%>"
                }
                console.log("mesId : ", delMess.mesId)
                console.log("gardenId : ", delMess.gardenId)

                axios({
                  method: "DELETE",
                  url: "/home/garden",
                  data: delMess
                }).then((res) => {
                  console.log("res.data", res.data)
                  if (res.data.result) {
                    alert("삭제되었습니다")
                    location.reload()
                  } else {
                    location.reload()
                  }
                }).catch((err) => {
                  console.log("에러발생")
                })

              }


              // $("buttion[name=delMsg]").on("click", function () {
              //   console.log("value : ", this.value)
              // })

              function profile() {
                axios({
                  method: "GET",
                  url: "/user/profile"
                }).then((res) => {
                  console.log('res', res.data)
                  if (res.data) location.href = '/user/profile'
                  else { alert("마이페이지 접근 불가 ;ㅁ;") }
                })
              }

            </script>
</body>

</html>